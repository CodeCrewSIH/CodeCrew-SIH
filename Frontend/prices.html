<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculate Price | Sparro</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="styles.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    /* Custom styles for the pricing page */
    body {
        background-color: #f8f9fa;
    }
    .pricing-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 20px;
    }
    .trip-summary-card {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    .trip-summary-card h2 {
        text-align: center;
        margin-bottom: 25px;
        color: #2c3e50;
    }
    .location-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.1rem;
        margin-bottom: 15px;
    }
    .location-display .material-icons {
        color: #6c63ff;
    }
    .distance-display {
        text-align: center;
        font-size: 1.3rem;
        font-weight: bold;
        color: #28a745;
        margin-top: 20px;
    }
    .calculator-card {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .vehicle-options-container {
        margin-top: 30px;
    }
    .vehicle-card {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
    }
    .vehicle-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    .vehicle-card .material-icons {
        font-size: 3.5rem;
        color: #6c63ff;
    }
    .vehicle-card h4 {
        margin: 10px 0;
        color: #34495e;
    }
    .vehicle-price {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2c3e50;
        margin-top: 10px;
    }
    .capacity-info {
        font-size: 0.9rem;
        color: #7f8c8d;
    }
    #loading-spinner {
        font-size: 1.5rem;
        text-align: center;
    }
  </style>
</head>

<body>
  <!-- Your existing header -->
  <header>
    <div class="logo"><img src="./assets/mainlogo.png" width="190px" alt="Sparro Logo"></div>
    <div class="logo1"><img src="./assets/textlogo.jpg" alt="Second Logo"></div>
    <nav>
      <ul id="nav-links">
        <li><a href="index.html">Home</a></li>
        <!-- Login/Signup or Profile Icon will be here -->
      </ul>
    </nav>
  </header>

  <main class="pricing-container">
    <div class="trip-summary-card">
      <h2>Your Trip Details</h2>
      <div class="location-display">
        <span><strong>From:</strong> <span id="start-location">...</span></span>
        <span class="material-icons">arrow_forward</span>
        <span><strong>To:</strong> <span id="end-location">...</span></span>
      </div>
      <div id="distance-result" class="distance-display">
        <div id="loading-spinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Calculating distance...</p>
        </div>
      </div>
    </div>

    <div class="calculator-card">
      <h3 class="text-center mb-4">Calculate Your Fare</h3>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="weight-input" class="form-label">Package Weight (in kg)</label>
          <input type="number" class="form-control" id="weight-input" min="1" placeholder="e.g., 50">
        </div>
        <div class="col-md-6">
          <label for="product-type-select" class="form-label">Product Type</label>
          <select id="product-type-select" class="form-select">
            <option value="general" selected>General Goods</option>
            <option value="fragile">Fragile Items</option>
            <option value="electronics">Electronics</option>
          </select>
        </div>
      </div>

      <div class="vehicle-options-container">
        <div class="row g-4">
          <!-- Pickup Option -->
          <div class="col-md-4">
            <div class="vehicle-card">
              <span class="material-icons">local_shipping</span>
              <h4>Pickup</h4>
              <p class="capacity-info">Capacity: Up to 1.5 Tons</p>
              <div class="vehicle-price" id="price-pickup">₹ ----</div>
              <button class="btn btn-primary mt-3">Book Now</button>
            </div>
          </div>
          <!-- Mini Truck Option -->
          <div class="col-md-4">
            <div class="vehicle-card">
              <span class="material-icons">rv_hookup</span>
              <h4>Mini Truck</h4>
              <p class="capacity-info">Capacity: Up to 4 Tons</p>
              <div class="vehicle-price" id="price-minitruck">₹ ----</div>
              <button class="btn btn-primary mt-3">Book Now</button>
            </div>
          </div>
          <!-- Large Truck Option -->
          <div class="col-md-4">
            <div class="vehicle-card">
              <span class="material-icons">fire_truck</span>
              <h4>Truck</h4>
              <p class="capacity-info">Capacity: Up to 8 Tons</p>
              <div class="vehicle-price" id="price-truck">₹ ----</div>
              <button class="btn btn-primary mt-3">Book Now</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let calculatedDistance = 0;

    // --- Pricing Configuration ---
    const pricingConfig = {
      vehicles: {
        pickup: { name: 'Pickup', baseRatePerKm: 25 },
        minitruck: { name: 'Mini Truck', baseRatePerKm: 40 },
        truck: { name: 'Truck', baseRatePerKm: 60 }
      },
      productTypeFee: {
        general: 0, // No extra charge
        fragile: 500, // Flat fee for fragile items
        electronics: 350 // Flat fee for electronics
      },
      weightSurcharge: {
        thresholdKg: 100,
        extraChargePerKg: 10
      }
    };

    function calculateAndDisplayPrices() {
      const weight = parseFloat(document.getElementById('weight-input').value) || 0;
      const productType = document.getElementById('product-type-select').value;

      if (calculatedDistance <= 0 || weight <= 0) {
        document.getElementById('price-pickup').textContent = '₹ ----';
        document.getElementById('price-minitruck').textContent = '₹ ----';
        document.getElementById('price-truck').textContent = '₹ ----';
        return;
      }

      // Calculate price for each vehicle
      for (const vehicleType in pricingConfig.vehicles) {
        const vehicle = pricingConfig.vehicles[vehicleType];
        
        // 1. Base fare from distance
        let totalCost = vehicle.baseRatePerKm * calculatedDistance;

        // 2. Add weight surcharge if applicable
        if (weight > pricingConfig.weightSurcharge.thresholdKg) {
          const extraWeight = weight - pricingConfig.weightSurcharge.thresholdKg;
          totalCost += extraWeight * pricingConfig.weightSurcharge.extraChargePerKg;
        }

        // 3. Add product type handling fee
        totalCost += pricingConfig.productTypeFee[productType];

        // 4. Update the UI
        document.getElementById(`price-${vehicleType}`).textContent = `₹ ${Math.round(totalCost).toLocaleString('en-IN')}`;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const startLocationEl = document.getElementById('start-location');
      const endLocationEl = document.getElementById('end-location');
      const distanceResultEl = document.getElementById('distance-result');
      const weightInput = document.getElementById('weight-input');
      const productTypeSelect = document.getElementById('product-type-select');

      // Get locations from localStorage
      const origin = localStorage.getItem('startLocation');
      const destination = localStorage.getItem('endLocation');

      if (!origin || !destination) {
        distanceResultEl.innerHTML = '<p class="text-danger">Locations not provided. Please go back and select your route.</p>';
        return;
      }

      startLocationEl.textContent = origin.split(',')[0];
      endLocationEl.textContent = destination.split(',')[0];

      try {
        // Fetch REAL distance from our backend
        const response = await fetch('https://codecrew-sparro.onrender.com/api/calculate-distance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ origin, destination })
        });
        
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        calculatedDistance = parseFloat(data.distance.replace(/,/g, ''));
        distanceResultEl.textContent = `Total Distance: ${data.distance}`;

        // Add event listeners AFTER distance is fetched
        weightInput.addEventListener('input', calculateAndDisplayPrices);
        productTypeSelect.addEventListener('change', calculateAndDisplayPrices);
        
      } catch (error) {
        console.error("Error fetching distance:", error);
        distanceResultEl.innerHTML = '<p class="text-danger">Could not calculate distance. Please try again.</p>';
      }
    });
  </script>
</body>
</html>

