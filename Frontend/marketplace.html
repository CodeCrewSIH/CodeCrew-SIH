<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Freight Marketplace | Sparro</title>
  <link rel="icon" href="./assets/logo.png">
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="styles.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    /* Page-specific styles for the marketplace */
    html, body {
      height: 100%;
      overflow: hidden; /* Prevent scrolling of the whole page */
    }
    .marketplace-container {
      display: flex;
      height: calc(100vh - 90px); /* Full height minus header */
    }
    #map {
      height: 100%;
      flex: 3; /* Map takes up 3/4 of the space */
    }
    .load-list-container {
      flex: 1; /* List takes up 1/4 of the space */
      height: 100%;
      overflow-y: auto; /* Make the list scrollable */
      background-color: #f8f9fa;
      border-left: 1px solid #ddd;
    }
    .load-list-header {
      padding: 20px;
      background-color: #343a40;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .load-item {
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .load-item:hover {
      background-color: #e9ecef;
    }
    .load-item.active {
        background-color: #d4edda; /* Light green for active item */
    }
    .load-item h5 {
      color: #6c63ff;
      margin-bottom: 5px;
      font-size: 1rem;
    }
    .load-item p {
      margin: 0;
      font-size: 0.9rem;
      color: #555;
    }
    .payout {
      font-weight: bold;
      color: #28a745;
    }
  </style>
</head>

<body>
  <!-- Your existing header -->
  <header>
    <div class="logo"><img src="./assets/mainlogo.png" width="190px" alt="Sparro Logo"></div>
    <div class="logo1"><img src="./assets/textlogo.jpg" alt="Second Logo"></div>
    <nav>
      <ul id="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="marketplace.html">Marketplace</a></li>
        <!-- Login/Signup or Profile Icon will be here -->
      </ul>
    </nav>
  </header>

  <div class="marketplace-container">
    <div id="map"></div>
    <div class="load-list-container">
      <div class="load-list-header">
        <h4>Available Loads</h4>
      </div>
      <div id="load-list">
        <!-- Load items will be dynamically inserted here by JavaScript -->
      </div>
    </div>
  </div>

  <script>
    // FAKE DATA for trailers/loads. You can add or change these.
    const availableLoads = [
      { id: 1, from: 'Delhi', to: 'Mumbai', cargo: 'Textiles (5 Tons)', payout: '35,000', lat: 28.6139, lng: 77.2090 },
      { id: 2, from: 'Bangalore', to: 'Chennai', cargo: 'Electronics (2.5 Tons)', payout: '22,000', lat: 12.9716, lng: 77.5946 },
      { id: 3, from: 'Kolkata', to: 'Hyderabad', cargo: 'Packaged Goods (7 Tons)', payout: '48,000', lat: 22.5726, lng: 88.3639 },
      { id: 4, from: 'Ahmedabad', to: 'Pune', cargo: 'Pharmaceuticals (4 Tons)', payout: '28,000', lat: 23.0225, lng: 72.5714 },
      { id: 5, from: 'Jaipur', to: 'Lucknow', cargo: 'Handicrafts (3 Tons)', payout: '19,500', lat: 26.9124, lng: 75.7873 },
      { id: 6, from: 'Greater Noida', to: 'Patna', cargo: 'Auto Parts (8 Tons)', payout: '41,000', lat: 28.4744, lng: 77.5040 }
    ];

    let map;
    const markers = []; // To keep track of map markers
    const infoWindow = new google.maps.InfoWindow();
    
    function initMap() {
      // Initialize the map, centered on India
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 20.5937, lng: 78.9629 }, // Center of India
        zoom: 5,
        mapId: 'SPARRO_MAP_ID' // A custom Map ID for styling
      });

      const loadList = document.getElementById('load-list');

      // Loop through our fake data to create markers and list items
      availableLoads.forEach(load => {
        // Create a list item
        const listItem = document.createElement('div');
        listItem.className = 'load-item';
        listItem.id = `load-${load.id}`;
        listItem.innerHTML = `
          <h5>${load.from} ➔ ${load.to}</h5>
          <p>${load.cargo}</p>
          <p class="payout">Est. Payout: ₹ ${load.payout}</p>
        `;
        loadList.appendChild(listItem);

        // Create a marker on the map
        const marker = new google.maps.Marker({
          position: { lat: load.lat, lng: load.lng },
          map,
          title: `${load.from} to ${load.to}`,
          // Using a custom truck icon for the marker
          icon: {
            url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M120-160v-80h521l-75-160H160v-80h380l75 160h125v80H120Zm40-240v-320h480v320H160Zm80-80h320v-160H240v160Zm520 80v-400q0-24.75-17.625-42.375T700-800H160q-24.75 0-42.375 17.625T100-740v400h40v80h-80v-480q0-42 29-71t71-29h540q42 0 71 29t29 71v480H760Z"/></svg>'),
            scaledSize: new google.maps.Size(30, 30),
          },
        });
        markers.push({id: load.id, marker: marker});

        const contentString = `
            <h5>Load from ${load.from}</h5>
            <p><strong>Destination:</strong> ${load.to}</p>
            <p><strong>Cargo:</strong> ${load.cargo}</p>
            <p><strong>Payout:</strong> ₹ ${load.payout}</p>
            <button class="btn btn-sm btn-primary">Accept Load</button>
        `;

        // Add a click listener for the marker
        marker.addListener("click", () => {
          infoWindow.setContent(contentString);
          infoWindow.open(map, marker);
          map.panTo(marker.getPosition());
          // Highlight the corresponding list item
          document.querySelectorAll('.load-item').forEach(item => item.classList.remove('active'));
          listItem.classList.add('active');
        });

        // Add a click listener for the list item
        listItem.addEventListener('click', () => {
            google.maps.event.trigger(marker, 'click');
        });
      });
    }
  </script>

  <script>
    // This script handles the login/logout display in the header
    document.addEventListener('DOMContentLoaded', () => {
        const navLinksContainer = document.getElementById('nav-links');
        const token = localStorage.getItem('authToken');
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const userInitial = payload.displayName ? payload.displayName.charAt(0).toUpperCase() : (payload.email ? payload.email.charAt(0).toUpperCase() : '?');
                const userEmail = payload.email || 'User email not found';

                navLinksContainer.innerHTML = `
                    <li><a href="index.html">Home</a></li>
                    <li><a href="marketplace.html">Marketplace</a></li>
                    <li class="profile-dropdown">
                        <div class="profile-icon" title="${userEmail}">${userInitial}</div>
                        <div class="dropdown-content">
                            <div class="user-email">${userEmail}</div>
                            <button id="logout-btn">Logout</button>
                        </div>
                    </li>
                `;
                const logoutButton = document.getElementById('logout-btn');
                logoutButton.addEventListener('click', () => {
                    localStorage.removeItem('authToken');
                    window.location.reload();
                });
            } catch (e) {
                console.error('Failed to decode token:', e);
                localStorage.removeItem('authToken');
            }
        }
    });
  </script>
  
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqXbLYqoa6s7EXiDHgWN_6jRInRBcjJx8&callback=initMap" async defer></script>
</body>
</html>

